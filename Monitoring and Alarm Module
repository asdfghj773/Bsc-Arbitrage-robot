"""
ç›‘æ§å’ŒæŠ¥è­¦æ¨¡å—
"""

import asyncio
import logging
from datetime import datetime, timedelta
from typing import Dict, List
import telegram
from telegram.ext import Application, CommandHandler, ContextTypes

class BotMonitor:
    """æœºå™¨äººç›‘æ§å™¨"""
    
    def __init__(self, bot_token: str, chat_id: str):
        self.bot_token = bot_token
        self.chat_id = chat_id
        self.bot = telegram.Bot(token=bot_token)
        self.alerts_sent = []
        
    async def send_alert(self, message: str, level: str = "INFO"):
        """å‘é€è­¦æŠ¥"""
        try:
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            formatted_message = f"[{timestamp}] [{level}]\n{message}"
            
            await self.bot.send_message(
                chat_id=self.chat_id,
                text=formatted_message,
                parse_mode='HTML'
            )
            
            self.alerts_sent.append({
                'timestamp': datetime.now(),
                'level': level,
                'message': message
            })
            
            logging.info(f"è­¦æŠ¥å·²å‘é€: {message}")
            
        except Exception as e:
            logging.error(f"å‘é€è­¦æŠ¥å¤±è´¥: {e}")
    
    async def send_opportunity_alert(self, opportunity):
        """å‘é€å¥—åˆ©æœºä¼šè­¦æŠ¥"""
        message = f"""
ğŸ”¥ <b>å‘ç°å¥—åˆ©æœºä¼š!</b>

ğŸ”„ ç±»å‹: {opportunity.id.split('_')[0].upper()}
ğŸ’° é¢„æœŸåˆ©æ¶¦: ${opportunity.net_profit:.2f}
ğŸ“ˆ åˆ©æ¶¦ç‡: {opportunity.profit_percentage:.2%}
âš ï¸ é£é™©ç­‰çº§: {opportunity.risk_score}/1.0
â° æ—¶é—´: {opportunity.timestamp.strftime('%H:%M:%S')}

è·¯å¾„: {' -> '.join([t.symbol for t in opportunity.path])}
        """
        
        await self.send_alert(message, "OPPORTUNITY")
    
    async def send_trade_alert(self, trade_result):
        """å‘é€äº¤æ˜“ç»“æœè­¦æŠ¥"""
        if trade_result['success']:
            message = f"""
âœ… <b>äº¤æ˜“æˆåŠŸ!</b>

ğŸ“Š åˆ©æ¶¦: ${trade_result['profit']:.2f}
ğŸ”— äº¤æ˜“å“ˆå¸Œ: {trade_result['tx_hash']}
â° æ—¶é—´: {trade_result['timestamp']}
            """
            await self.send_alert(message, "SUCCESS")
        else:
            message = f"""
âŒ <b>äº¤æ˜“å¤±è´¥!</b>

ğŸ“ é”™è¯¯ä¿¡æ¯: {trade_result['error']}
â° æ—¶é—´: {trade_result['timestamp']}
            """
            await self.send_alert(message, "ERROR")
    
    async def send_daily_report(self, stats: Dict):
        """å‘é€æ¯æ—¥æŠ¥å‘Š"""
        message = f"""
ğŸ“Š <b>æ¯æ—¥æŠ¥å‘Š</b>

ğŸ“… æ—¥æœŸ: {datetime.now().strftime('%Y-%m-%d')}
ğŸ’° æ€»åˆ©æ¶¦: ${stats['total_profit']:.2f}
ğŸ“ˆ æ€»äº¤æ˜“: {stats['total_trades']}
âœ… æˆåŠŸäº¤æ˜“: {stats['successful_trades']}
ğŸ¯ æˆåŠŸç‡: {stats['success_rate']:.1f}%
âš¡ å½“å‰Gasä»·æ ¼: {stats['gas_price']:.1f} Gwei
        """
        
        await self.send_alert(message, "REPORT")
    
    async def check_health(self, bot_status: Dict) -> bool:
        """æ£€æŸ¥æœºå™¨äººå¥åº·çŠ¶æ€"""
        issues = []
        
        # æ£€æŸ¥RPCè¿æ¥
        if not bot_status.get('rpc_connected', False):
            issues.append("RPCè¿æ¥å¤±è´¥")
        
        # æ£€æŸ¥é’±åŒ…ä½™é¢
        if bot_status.get('wallet_balance', 0) < 0.01:
            issues.append("é’±åŒ…ä½™é¢ä¸è¶³ (< 0.01 BNB)")
        
        # æ£€æŸ¥æœ€è¿‘æ´»åŠ¨
        last_activity = bot_status.get('last_activity')
        if last_activity and (datetime.now() - last_activity) > timedelta(minutes=5):
            issues.append("5åˆ†é’Ÿå†…æ— æ´»åŠ¨")
        
        if issues:
            message = f"""
âš ï¸ <b>å¥åº·æ£€æŸ¥å‘ç°é—®é¢˜</b>

é—®é¢˜åˆ—è¡¨:
{chr(10).join([f'â€¢ {issue}' for issue in issues])}

è¯·ç«‹å³æ£€æŸ¥!
            """
            await self.send_alert(message, "WARNING")
            return False
        
        return True

# Telegramå‘½ä»¤å¤„ç†å™¨
async def start_command(update, context):
    """å¤„ç†/startå‘½ä»¤"""
    await update.message.reply_text(
        "ğŸ¤– BSCå¥—åˆ©æœºå™¨äººç›‘æ§\n\n"
        "å¯ç”¨å‘½ä»¤:\n"
        "/status - æŸ¥çœ‹æœºå™¨äººçŠ¶æ€\n"
        "/profit - æŸ¥çœ‹åˆ©æ¶¦ç»Ÿè®¡\n"
        "/pause - æš‚åœæœºå™¨äºº\n"
        "/resume - æ¢å¤æœºå™¨äºº\n"
        "/gas - æŸ¥çœ‹å½“å‰Gasä»·æ ¼\n"
        "/help - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    )

async def status_command(update, context):
    """å¤„ç†/statuså‘½ä»¤"""
    # è¿™é‡Œè·å–æœºå™¨äººçŠ¶æ€
    status = {
        'running': True,
        'total_profit': 123.45,
        'active_opportunities': 3,
        'wallet_balance': 0.5
    }
    
    message = f"""
ğŸ“Š <b>æœºå™¨äººçŠ¶æ€</b>

è¿è¡ŒçŠ¶æ€: {'âœ… è¿è¡Œä¸­' if status['running'] else 'â¸ï¸ å·²æš‚åœ'}
æ€»åˆ©æ¶¦: ${status['total_profit']:.2f}
æ´»è·ƒæœºä¼š: {status['active_opportunities']}
é’±åŒ…ä½™é¢: {status['wallet_balance']:.3f} BNB
    """
    
    await update.message.reply_text(message, parse_mode='HTML')

async def setup_telegram_bot(bot_token: str):
    """è®¾ç½®Telegramæœºå™¨äºº"""
    application = Application.builder().token(bot_token).build()
    
    # æ·»åŠ å‘½ä»¤å¤„ç†å™¨
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("status", status_command))
    
    return application
